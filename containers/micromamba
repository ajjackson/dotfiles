FROM mambaorg/micromamba:1.5.1-focal
COPY --chown=$MAMBA_USER:$MAMBA_USER env.yaml /tmp/env.yaml
COPY micromamba-apt-packages.txt /tmp/apt-packages.txt

USER root
RUN apt-get update
RUN xargs apt-get install -y < /tmp/apt-packages.txt

VOLUME /etc/dotfiles

RUN echo "useradd --create-home $MAMBA_USER"
RUN mkhomedir_helper $MAMBA_USER

USER $MAMBA_USER
WORKDIR /home/$MAMBA_USER

RUN micromamba install -y -n base -f /tmp/env.yaml && \
    micromamba clean --all --yes

RUN bash -c 'eval "$(micromamba shell hook --shell bash)"; micromamba activate base; condax install "emacs<29" '

# RUN cp -r /etc/dotfiles $HOME/src/
# RUN cd $HOME/src/
# RUN PATH=$HOME/.local/bin:$PATH ./make.el
